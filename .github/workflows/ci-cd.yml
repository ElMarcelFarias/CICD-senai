name: "ğŸš€ DevOps Demo â€¢ CI/CD"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_NAME: devops
  DIST_DIR: dist
  SRC_FILE: src/index.html

permissions:
  contents: read

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    name: "ğŸ—ï¸ Build & Qualidade"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "ğŸ” AnÃ¡lise rÃ¡pida do projeto"
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ” Estrutura do repositÃ³rio:"
          tree -a -I ".git" || ls -la
          echo

          echo "ğŸ“ Checando arquivos essenciais..."
          [[ -f "${{ env.SRC_FILE }}" ]] || { echo "âŒ ${SRC_FILE} nÃ£o encontrado"; exit 1; }
          [[ -f ".github/workflows/${GITHUB_WORKFLOW_REF##*/}" ]] || echo "â„¹ï¸ Workflow atual nÃ£o estÃ¡ salvo em arquivo padrÃ£o"
          echo "âœ… Arquivos essenciais verificados"

      - name: "ğŸ§ª Testes de qualidade (HTML/CSS/JS/A11y bÃ¡sico)"
        shell: bash
        run: |
          set -euo pipefail
          HTML="${{ env.SRC_FILE }}"
          echo "ğŸ” Teste 1: DOCTYPE..."
          grep -q "<!DOCTYPE html>" "$HTML" && echo "âœ… DOCTYPE HTML5 presente"

          echo "ğŸ” Teste 2: <title>..."
          grep -q "<title>" "$HTML" && echo "âœ… Tag <title> presente"

          echo "ğŸ” Teste 3: CSS embarcado..."
          if grep -q "<style" "$HTML"; then echo "âœ… CSS encontrado"; else echo "âš ï¸ Sem CSS embarcado"; fi

          echo "ğŸ” Teste 4: JavaScript..."
          if grep -q "<script" "$HTML"; then echo "âœ… JavaScript encontrado"; else echo "âš ï¸ Sem JavaScript"; fi

          echo "ğŸ” Teste 5: Acessibilidade (alt/aria)..."
          if grep -Eq 'alt=|aria-' "$HTML"; then
            echo "âœ… Atributos de acessibilidade identificados"
          else
            echo "âš ï¸ Considere adicionar atributos de acessibilidade (alt/aria-*)"
          fi

          echo "ğŸ‰ Checks de qualidade finalizados"

      - name: "ğŸ—ï¸ Build"
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ”¨ Preparando diretÃ³rio de saÃ­da..."
          rm -rf "${{ env.DIST_DIR }}"
          mkdir -p "${{ env.DIST_DIR }}"

          echo "ğŸ“‚ Copiando artefatos..."
          cp -r src/* "${{ env.DIST_DIR }}/"

          echo "ğŸ“ build-info.json"
          cat > "${{ env.DIST_DIR }}/build-info.json" << EOF
          {
            "buildId": "${{ github.run_number }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "actor": "${{ github.actor }}",
            "project": "${{ env.PROJECT_NAME }}",
            "status": "success"
          }
          EOF

          echo "ğŸ” SHA256 dos arquivos:"
          (cd "${{ env.DIST_DIR }}" && sha256sum * || shasum -a 256 *)

      - name: "ğŸ” ValidaÃ§Ã£o do build"
        shell: bash
        run: |
          set -euo pipefail
          files=("${{ env.DIST_DIR }}/index.html" "${{ env.DIST_DIR }}/build-info.json")
          for f in "${files[@]}"; do
            [[ -f "$f" ]] || { echo "âŒ Faltando $f"; exit 1; }
            echo "âœ… $f - $(stat -c%s "$f" 2>/dev/null || stat -f%z "$f") bytes"
          done

          echo "ğŸ” ConteÃºdo esperado?"
          if grep -qi "DevOps" "${{ env.DIST_DIR }}/index.html"; then
            echo "âœ… ConteÃºdo HTML menciona 'DevOps'"
          else
            echo "âš ï¸ 'DevOps' nÃ£o encontrado no HTML"
          fi

          echo "ğŸ“Š EstatÃ­sticas:"
          echo "  Tamanho total: $(du -sh '${{ env.DIST_DIR }}' | cut -f1)"
          echo "  Arquivos: $(find '${{ env.DIST_DIR }}' -type f | wc -l)"

      - name: "ğŸ“¦ Upload de artefatos"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-build-${{ github.run_number }}
          path: ${{ env.DIST_DIR }}/
          retention-days: 14

      - name: "ğŸ§¾ Resumo do build"
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # âœ… Build concluÃ­do
          - **Projeto:** \`${{ env.PROJECT_NAME }}\`
          - **Build:** \`#${{ github.run_number }}\`
          - **Branch:** \`${{ github.ref_name }}\`
          - **Autor:** \`${{ github.actor }}\`
          - **Artefato:** \`${{ env.PROJECT_NAME }}-build-${{ github.run_number }}\`
          EOF

  deploy:
    name: "ğŸš€ Deploy (simulado)"
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: "ğŸ“¥ Baixar artefatos"
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-build-${{ github.run_number }}
          path: ${{ env.DIST_DIR }}/

      - name: "ğŸ” VerificaÃ§Ã£o pÃ³s-download"
        shell: bash
        run: |
          set -euo pipefail
          ls -la "${{ env.DIST_DIR }}"
          echo "ğŸ“„ build-info.json:"
          cat "${{ env.DIST_DIR }}/build-info.json"

      - name: "ğŸš€ Deploy de produÃ§Ã£o (demo)"
        id: deploy
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ”§ Preparando ambiente..."
          export DEPLOY_ENV=production
          export APP_NAME="${{ env.PROJECT_NAME }}"

          echo "ğŸ“¤ Enviando arquivos (simulado)..."
          count=$(find "${{ env.DIST_DIR }}" -type f | wc -l)
          for i in $(seq 1 "$count"); do
            echo "â¬†ï¸  Upload $i/$count"
            sleep 0.2
          done

          echo "ğŸ”„ ConfiguraÃ§Ã£o do servidor (simulada)..."
          echo "  - Limpando cache"
          echo "  - Atualizando Nginx"
          echo "  - Reiniciando serviÃ§os"

          echo "ğŸ¥ Health check..."
          sleep 1
          echo "âœ… OK"

          URL="https://${{ env.PROJECT_NAME }}.exemplo.com"
          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "âœ… Deploy finalizado"

      - name: "ğŸ§¾ Resumo do deploy"
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # ğŸš€ Deploy (simulado)
          - **Ambiente:** ProduÃ§Ã£o
          - **Commit:** \`${{ github.sha }}\`
          - **URL:** ${{ steps.deploy.outputs.url }}
          - **Status:** âœ… Sucesso
          EOF

  post-deploy-tests:
    name: "ğŸ§ª PÃ³s-Deploy"
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: "ğŸ”¥ Smoke tests"
        shell: bash
        run: |
          set -euo pipefail
          echo "ğŸ”Œ Conectividade... âœ…"
          echo "â±ï¸ Response time... 45ms âœ…"
          echo "ğŸ“¡ Status HTTP... 200 âœ…"
          echo "ğŸ§© ValidaÃ§Ã£o de conteÃºdo... âœ…"
          echo "ğŸ‰ Smoke tests aprovados"

      - name: "ğŸ“Š RelatÃ³rio final"
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # ğŸ“Š RelatÃ³rio Final do Pipeline
          - **Build:** âœ…
          - **Testes:** âœ…
          - **Deploy:** âœ…
          - **URL:** https://${{ env.PROJECT_NAME }}.exemplo.com
          EOF
